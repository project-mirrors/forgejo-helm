platform: linux/amd64

depends_on:
  - lint

when:
  event:
    - tag
  tag: v*

pipeline:
  generate-chart:
    image: alpine:3.17
    pull: true
    commands:
      - apk add --no-cache -X http://dl-cdn.alpinelinux.org/alpine/edge/testing helm
      - apk add --no-cache git
      - helm dependency build
      - rm -rf tmp/
      - helm package --version "${CI_COMMIT_TAG##v}" -d tmp/ ./
      - echo $${TOKEN} | helm registry login -u viceice --password-stdin codeberg.org/forgejo-contrib
      - helm push tmp/forgejo-${CI_COMMIT_TAG##v}.tgz oci://codeberg.org/forgejo-contrib
    secrets:
      - token
