platform: linux/amd64

when:
  event:
    - pull_request
    - tag
    - push
  branch:
    - main
    - release/**

pipeline:
  prettier:
    image: alpine:3.18.5
    pull: true
    commands:
      - apk add nodejs npm
      - npm run prettier

  deps:
    image: alpine:3.18.5
    pull: true
    commands:
      - apk add helm
      - helm dependency build

  helm-lint:
    image: alpine:3.18.5
    pull: true
    commands:
      - apk add helm
      - helm lint

  helm-template:
    image: alpine:3.18.5
    pull: true
    commands:
      - apk add helm
      - helm template --debug gitea-helm .

  helm-unittests:
    image: alpine:3.18.5
    pull: true
    commands:
      - apk add make helm git bash
      - helm plugin install --version v0.3.6 https://github.com/helm-unittest/helm-unittest
      - helm dependency update
      - make unittests

  verify-readme:
    image: alpine:3.18.5
    pull: true
    commands:
      - apk add make nodejs npm git
      - make readme
      - git diff --exit-code --name-only README.md

  yaml-lint:
    image: quay.io/helmpack/chart-testing:v3.10.1
    pull: true
    commands:
      - yamllint -f colored .

  ct-lint:
    image: quay.io/helmpack/chart-testing:v3.10.1
    pull: true
    commands:
      - git fetch --no-tags --filter=blob:none origin
      - ct lint --config tools/ct.yml --charts .
